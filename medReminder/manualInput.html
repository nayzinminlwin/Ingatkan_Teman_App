<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title data-i18n-title="addSchedule.pageTitle">Add Schedule</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="page form-page">
      <header class="page-header">
        <a href="medReminderHome.html" class="back-btn" data-i18n="common.back"
          >← Back</a
        >
        <h1 data-i18n="addSchedule.pageTitle">Add New Schedule</h1>
      </header>

      <!-- Adik Ahmad Helper Scene -->
      <section class="scene">
        <img src="../assets/Adik_Ahmad.png" alt="Adik Ahmad" class="avatar" />
        <div class="bubble">
          <p data-i18n="addSchedule.helperText">
            Tell me about your medicine, Nenek. I'll help you remember!
          </p>
        </div>
      </section>

      <form class="form-container" id="scheduleForm">
        <div class="input-wrapper" id="inputWrapper">
          <div class="input-card">
            <header class="card-header">
              <span class="card-number"
                ><span data-i18n="addSchedule.medicineNumber">Medicine #</span
                >1</span
              >
              <button type="button" class="remove-card-btn" aria-label="Remove">
                ×
              </button>
            </header>

            <div class="field-group">
              <label for="med-name-1" data-i18n="addSchedule.medicineName"
                >Medicine Name</label
              >
              <input
                id="med-name-1"
                name="medicineName[]"
                type="text"
                list="medNames"
                data-i18n-placeholder="addSchedule.medicineNamePlaceholder"
                placeholder="e.g., Paracetamol"
                required
              />
              <datalist id="medNames">
                <option value="Paracetamol"></option>
                <option value="Aspirin"></option>
                <option value="Amoxicillin"></option>
                <option value="Vitamin C"></option>
                <option value="Vitamin D"></option>
                <option value="Blood Pressure Med"></option>
                <option value="Diabetes Med"></option>
              </datalist>
            </div>

            <div class="field-group">
              <label for="dosage-1" data-i18n="addSchedule.dosage"
                >Dosage</label
              >
              <input
                id="dosage-1"
                name="dosage[]"
                type="text"
                data-i18n-placeholder="addSchedule.dosagePlaceholder"
                placeholder="e.g., 2 tablets"
                required
              />
            </div>

            <div class="field-group">
              <label for="time-1" data-i18n="addSchedule.reminderTime"
                >Reminder Time</label
              >
              <input id="time-1" name="time[]" type="time" required />
            </div>

            <div class="field-group">
              <label for="instruction-1" data-i18n="addSchedule.instructions"
                >Instructions</label
              >
              <select id="instruction-1" name="instruction[]">
                <option
                  value="after-breakfast"
                  data-i18n="addSchedule.afterBreakfast"
                >
                  After Breakfast
                </option>
                <option
                  value="before-breakfast"
                  data-i18n="addSchedule.beforeBreakfast"
                >
                  Before Breakfast
                </option>
                <option value="after-lunch" data-i18n="addSchedule.afterLunch">
                  After Lunch
                </option>
                <option
                  value="before-lunch"
                  data-i18n="addSchedule.beforeLunch"
                >
                  Before Lunch
                </option>
                <option
                  value="after-dinner"
                  data-i18n="addSchedule.afterDinner"
                >
                  After Dinner
                </option>
                <option
                  value="before-dinner"
                  data-i18n="addSchedule.beforeDinner"
                >
                  Before Dinner
                </option>
                <option
                  value="before-sleep"
                  data-i18n="addSchedule.beforeSleep"
                >
                  Before Sleep
                </option>
              </select>
            </div>

            <div class="field-group">
              <label for="repeat-1" data-i18n="addSchedule.repeat"
                >Repeat</label
              >
              <select id="repeat-1" name="repeat[]">
                <option value="daily" data-i18n="addSchedule.everyDay">
                  Every Day
                </option>
                <option value="weekdays" data-i18n="addSchedule.weekdaysOnly">
                  Weekdays Only
                </option>
                <option value="weekly" data-i18n="addSchedule.weekly">
                  Weekly
                </option>
                <option value="monthly" data-i18n="addSchedule.monthly">
                  Monthly
                </option>
                <option value="once" data-i18n="addSchedule.oneTimeOnly">
                  One Time Only
                </option>
              </select>
            </div>
          </div>
        </div>

        <button
          class="btn-secondary"
          type="button"
          id="addMoreBtn"
          data-i18n="addSchedule.addAnother"
        >
          + Add Another Medicine
        </button>

        <button
          class="btn-primary"
          type="submit"
          data-i18n="addSchedule.saveSchedule"
        >
          ✓ Save Schedule
        </button>
      </form>
    </main>

    <!-- i18n Script -->
    <script src="../i18n/i18n.js"></script>

    <script>
      // ========== CONFIGURATION ==========
      const DATA_PATH = "../assets/dummyData/medicationSchedules.JSON";
      const STORAGE_KEY = "ingatkanTeman_schedules";

      const addMoreBtn = document.getElementById("addMoreBtn");
      const inputWrapper = document.getElementById("inputWrapper");
      let cardCount = 1;

      // Get language
      function getLang() {
        return I18n.getLanguage() === "bm" ? "bm" : "en";
      }

      addMoreBtn.addEventListener("click", () => {
        cardCount++;
        const firstCard = inputWrapper.querySelector(".input-card");
        if (!firstCard) return;

        const clone = firstCard.cloneNode(true);

        // Update card number
        const cardNumber = clone.querySelector(".card-number");
        const prefix = I18n.t("addSchedule.medicineNumber");
        cardNumber.innerHTML = `${prefix}${cardCount}`;

        // Show remove button
        const removeBtn = clone.querySelector(".remove-card-btn");
        removeBtn.classList.add("visible");
        removeBtn.addEventListener("click", function () {
          clone.remove();
          updateCardNumbers();
        });

        // Clear and update IDs
        const inputs = clone.querySelectorAll("input, select");
        inputs.forEach((input) => {
          if (input.type !== "datalist") {
            input.value = "";
          }
          if (input.id) {
            input.id = input.id.replace(/-\d+$/, `-${cardCount}`);
          }
        });

        const labels = clone.querySelectorAll("label");
        labels.forEach((label) => {
          const forAttr = label.getAttribute("for");
          if (forAttr) {
            label.setAttribute(
              "for",
              forAttr.replace(/-\d+$/, `-${cardCount}`),
            );
          }
        });

        inputWrapper.appendChild(clone);
      });

      function updateCardNumbers() {
        const cards = inputWrapper.querySelectorAll(".input-card");
        const prefix = I18n.t("addSchedule.medicineNumber");
        cards.forEach((card, index) => {
          const cardNumber = card.querySelector(".card-number");
          cardNumber.innerHTML = `${prefix}${index + 1}`;

          // Hide remove button on first card
          const removeBtn = card.querySelector(".remove-card-btn");
          if (index === 0) {
            removeBtn.classList.remove("visible");
          }
        });
        cardCount = cards.length;
      }

      // ========== LOAD EXISTING SCHEDULES DATA ==========
      async function loadSchedulesData() {
        // First check localStorage
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          try {
            return JSON.parse(savedData);
          } catch (e) {
            console.error("Error parsing saved schedules:", e);
          }
        }

        // Load from JSON file
        try {
          const response = await fetch(DATA_PATH);
          return await response.json();
        } catch (error) {
          console.error("Failed to load schedules:", error);
          // Return default structure
          return {
            schedules: [],
            instructionLabels: {
              "after-breakfast": {
                en: "After Breakfast",
                bm: "Selepas Sarapan",
              },
              "before-breakfast": {
                en: "Before Breakfast",
                bm: "Sebelum Sarapan",
              },
              "after-lunch": {
                en: "After Lunch",
                bm: "Selepas Makan Tengahari",
              },
              "before-lunch": {
                en: "Before Lunch",
                bm: "Sebelum Makan Tengahari",
              },
              "after-dinner": { en: "After Dinner", bm: "Selepas Makan Malam" },
              "before-dinner": {
                en: "Before Dinner",
                bm: "Sebelum Makan Malam",
              },
              "before-sleep": { en: "Before Sleep", bm: "Sebelum Tidur" },
            },
            repeatLabels: {
              daily: { en: "Every Day", bm: "Setiap Hari" },
              weekdays: { en: "Weekdays Only", bm: "Hari Bekerja Sahaja" },
              weekly: { en: "Weekly", bm: "Setiap Minggu" },
              monthly: { en: "Monthly", bm: "Setiap Bulan" },
              once: { en: "One Time Only", bm: "Sekali Sahaja" },
            },
            statusLabels: {
              taken: { en: "Taken", bm: "Sudah Ambil" },
              upcoming: { en: "Next", bm: "Seterusnya" },
              pending: { en: "Pending", bm: "Menunggu" },
              missed: { en: "Missed", bm: "Terlepas" },
            },
          };
        }
      }

      // ========== SAVE SCHEDULES ==========
      function saveSchedules(schedulesData) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(schedulesData));
      }

      // ========== FORM SUBMISSION ==========
      document
        .getElementById("scheduleForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Load existing data
          const schedulesData = await loadSchedulesData();

          // Collect all medicine cards
          const cards = inputWrapper.querySelectorAll(".input-card");
          const newSchedules = [];

          cards.forEach((card, index) => {
            const medName = card
              .querySelector(`[name="medicineName[]"]`)
              .value.trim();
            const dosage = card.querySelector(`[name="dosage[]"]`).value.trim();
            const time = card.querySelector(`[name="time[]"]`).value;
            const instruction = card.querySelector(
              `[name="instruction[]"]`,
            ).value;
            const repeat = card.querySelector(`[name="repeat[]"]`).value;

            if (medName && dosage && time) {
              // Generate dosage in BM (simple conversion)
              const dosageBM = dosage
                .replace(/tablets?/i, "biji")
                .replace(/capsules?/i, "kapsul")
                .replace(/spoons?/i, "sudu");

              newSchedules.push({
                id: "sched_" + Date.now() + "_" + index,
                medicineName: medName,
                dosage: dosage,
                dosage_BM: dosageBM,
                time: time,
                instruction: instruction,
                repeat: repeat,
                status: "pending",
                createdAt: new Date().toISOString(),
                takenAt: null,
              });
            }
          });

          if (newSchedules.length === 0) {
            alert(
              getLang() === "bm"
                ? "Sila isi sekurang-kurangnya satu ubat."
                : "Please fill in at least one medicine.",
            );
            return;
          }

          // Add new schedules to existing ones
          schedulesData.schedules = [
            ...schedulesData.schedules,
            ...newSchedules,
          ];
          saveSchedules(schedulesData);

          // Show success message
          const bubble = document.querySelector(".bubble p");
          bubble.textContent = I18n.t("addSchedule.savedMessage");

          // Disable form
          const submitBtn = this.querySelector('[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.textContent =
            getLang() === "bm" ? "✓ Disimpan!" : "✓ Saved!";

          // Redirect after delay
          setTimeout(() => {
            window.location.href = "medReminderHome.html";
          }, 1500);
        });
    </script>
  </body>
</html>
