<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title data-i18n-title="medReminder.pageTitle">Medication Reminder</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="page reminder-home">
      <header class="page-header">
        <a href="../main/homePage.html" class="back-btn" data-i18n="common.back"
          >‚Üê Back</a
        >
        <h1 data-i18n="medReminder.pageTitle">Medication Reminder</h1>
      </header>

      <!-- Adik Ahmad Welcome Scene -->
      <section class="scene">
        <img src="../assets/Adik_Ahmad.png" alt="Adik Ahmad" class="avatar" />
        <div class="bubble">
          <p data-i18n="medReminder.greeting">
            Hi Nenek! Have you taken your medicine this morning?
          </p>
        </div>
      </section>

      <!-- Quick Stats Dashboard -->
      <section class="stats-row">
        <div class="stat-card success">
          <span class="stat-icon">‚úÖ</span>
          <span class="stat-value" id="takenCount">0</span>
          <span class="stat-label" data-i18n="medReminder.taken">Taken</span>
        </div>
        <div class="stat-card warning">
          <span class="stat-icon">‚è∞</span>
          <span class="stat-value" id="upcomingCount">0</span>
          <span class="stat-label" data-i18n="medReminder.upcoming"
            >Upcoming</span
          >
        </div>
        <div class="stat-card danger">
          <span class="stat-icon">‚ö†Ô∏è</span>
          <span class="stat-value" id="missedCount">0</span>
          <span class="stat-label" data-i18n="medReminder.missed">Missed</span>
        </div>
      </section>

      <!-- Today's Schedule Section -->
      <h2 class="section-title" data-i18n="medReminder.todaySchedule">
        Today's Schedule
      </h2>
      <section class="schedule-list" id="scheduleList">
        <!-- Schedule cards will be injected dynamically -->
        <p class="loading-message" id="loadingMessage">Loading schedules...</p>
      </section>
    </main>

    <!-- Fixed Bottom Toolbar -->
    <footer class="fixed-toolbar">
      <a class="toolbar-btn primary" href="manualInput.html">
        <span class="toolbar-icon">‚ûï</span>
        <span class="toolbar-label" data-i18n="medReminder.add">Add</span>
      </a>
      <a class="toolbar-btn" href="OCRScanPage.html">
        <span class="toolbar-icon">üì∑</span>
        <span class="toolbar-label" data-i18n="medReminder.scan">Scan</span>
      </a>
      <a class="toolbar-btn" href="#">
        <span class="toolbar-icon">üìÖ</span>
        <span class="toolbar-label" data-i18n="medReminder.history"
          >History</span
        >
      </a>
      <a class="toolbar-btn" href="#">
        <span class="toolbar-icon">‚öôÔ∏è</span>
        <span class="toolbar-label" data-i18n="medReminder.settings"
          >Settings</span
        >
      </a>
    </footer>

    <!-- i18n Script -->
    <script src="../i18n/i18n.js"></script>

    <script>
      // ========== CONFIGURATION ==========
      const DATA_PATH = "../assets/dummyData/medicationSchedules.JSON";
      const STORAGE_KEY = "ingatkanTeman_schedules";

      // Data containers
      let schedulesData = null;
      let schedules = [];

      // Get language
      function getLang() {
        return I18n.getLanguage() === "bm" ? "bm" : "en";
      }

      // Get label from bilingual object
      function getLabel(labelObj) {
        if (!labelObj) return "";
        return labelObj[getLang()] || labelObj.en || "";
      }

      // ========== INITIALIZE ==========
      I18n.init(async function () {
        await loadSchedules();
        renderSchedules();
        updateStats();
      });

      // ========== LOAD SCHEDULES ==========
      async function loadSchedules() {
        // First check localStorage for any saved schedules
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          try {
            schedulesData = JSON.parse(savedData);
            schedules = schedulesData.schedules || [];
            return;
          } catch (e) {
            console.error("Error parsing saved schedules:", e);
          }
        }

        // Load from JSON file
        try {
          const response = await fetch(DATA_PATH);
          schedulesData = await response.json();
          schedules = schedulesData.schedules || [];
          // Save to localStorage for persistence
          saveSchedules();
        } catch (error) {
          console.error("Failed to load schedules:", error);
          schedules = [];
        }
      }

      // ========== SAVE SCHEDULES ==========
      function saveSchedules() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(schedulesData));
      }

      // ========== RENDER SCHEDULES ==========
      function renderSchedules() {
        const scheduleList = document.getElementById("scheduleList");
        const loadingMsg = document.getElementById("loadingMessage");

        if (loadingMsg) loadingMsg.remove();

        if (schedules.length === 0) {
          scheduleList.innerHTML = `
            <div class="empty-state">
              <p>${I18n.t("medReminder.noSchedules")}</p>
            </div>
          `;
          return;
        }

        // Sort schedules by time
        const sortedSchedules = [...schedules].sort((a, b) => {
          return a.time.localeCompare(b.time);
        });

        scheduleList.innerHTML = sortedSchedules
          .map((schedule) => {
            const statusClass = schedule.status || "pending";
            const instructionLabel = getLabel(
              schedulesData.instructionLabels[schedule.instruction],
            );
            const statusLabel = getLabel(
              schedulesData.statusLabels[schedule.status],
            );
            const dosage =
              getLang() === "bm" && schedule.dosage_BM
                ? schedule.dosage_BM
                : schedule.dosage;

            // Format time
            const [hours, minutes] = schedule.time.split(":");
            const hour12 = parseInt(hours) % 12 || 12;
            const ampm = parseInt(hours) >= 12 ? "PM" : "AM";

            return `
            <article class="schedule-card ${statusClass}" data-id="${schedule.id}">
              <div class="schedule-info">
                <h3 class="schedule-name">${schedule.medicineName}</h3>
                <p class="schedule-detail">${dosage} ‚Ä¢ ${instructionLabel}</p>
              </div>
              <div class="schedule-time">
                <span class="time-value">${hour12}:${minutes}</span>
                <span class="time-label">${ampm}</span>
              </div>
              ${statusLabel ? `<span class="status-badge ${statusClass}">${statusLabel}</span>` : ""}
              <div class="schedule-actions">
                <button class="action-btn take-btn" data-id="${schedule.id}" title="${I18n.t("medReminder.markTaken")}">‚úì</button>
                <button class="action-btn delete-btn" data-id="${schedule.id}" title="${I18n.t("medReminder.delete")}">√ó</button>
              </div>
            </article>
          `;
          })
          .join("");

        // Attach event listeners to action buttons
        attachCardListeners();
      }

      // ========== CARD ACTION LISTENERS ==========
      function attachCardListeners() {
        // Take medication buttons
        document.querySelectorAll(".take-btn").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            const id = this.dataset.id;
            markAsTaken(id);
          });
        });

        // Delete buttons
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            const id = this.dataset.id;
            deleteSchedule(id);
          });
        });
      }

      // ========== MARK AS TAKEN ==========
      function markAsTaken(id) {
        const schedule = schedules.find((s) => s.id === id);
        if (schedule) {
          schedule.status = "taken";
          schedule.takenAt = new Date().toISOString();
          saveSchedules();
          renderSchedules();
          updateStats();

          // Update greeting message
          const bubble = document.querySelector(".bubble p");
          bubble.textContent = I18n.t("medReminder.markedTaken").replace(
            "{name}",
            schedule.medicineName,
          );
        }
      }

      // ========== DELETE SCHEDULE ==========
      function deleteSchedule(id) {
        const confirmMsg =
          getLang() === "bm"
            ? "Adakah anda pasti mahu padam jadual ini?"
            : "Are you sure you want to delete this schedule?";

        if (confirm(confirmMsg)) {
          schedules = schedules.filter((s) => s.id !== id);
          schedulesData.schedules = schedules;
          saveSchedules();
          renderSchedules();
          updateStats();
        }
      }

      // ========== UPDATE STATS ==========
      function updateStats() {
        let taken = 0,
          upcoming = 0,
          missed = 0,
          pending = 0;

        schedules.forEach((schedule) => {
          switch (schedule.status) {
            case "taken":
              taken++;
              break;
            case "upcoming":
              upcoming++;
              break;
            case "missed":
              missed++;
              break;
            default:
              pending++;
          }
        });

        document.getElementById("takenCount").textContent = taken;
        document.getElementById("upcomingCount").textContent =
          upcoming + pending;
        document.getElementById("missedCount").textContent = missed;
      }

      // ========== ADD NEW SCHEDULE (called from manualInput) ==========
      function addSchedule(newSchedule) {
        newSchedule.id = "sched_" + Date.now();
        newSchedule.status = "pending";
        newSchedule.createdAt = new Date().toISOString();
        newSchedule.takenAt = null;

        schedules.push(newSchedule);
        schedulesData.schedules = schedules;
        saveSchedules();
      }

      // Expose for external use
      window.MedScheduler = {
        addSchedule,
        loadSchedules,
        getSchedules: () => schedules,
      };
    </script>
  </body>
</html>
