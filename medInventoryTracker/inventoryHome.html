<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Medicine Inventory</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="page inventory-home">
      <header class="page-header">
        <a href="../main/homePage.html" class="back-btn">‚Üê Back</a>
        <h1>Medicine Inventory</h1>
      </header>

      <!-- PakCik Firdaus Welcome Scene -->
      <section class="scene">
        <img
          src="../assets/PakCik_Firdaus.png"
          alt="PakCik Firdaus"
          class="avatar"
        />
        <div class="bubble">
          <p>
            Selamat datang, Nenek! You have
            <strong class="alert-count" id="alertCount">0 alerts</strong> today.
          </p>
        </div>
      </section>

      <!-- Quick Stats Dashboard -->
      <section class="stats-row">
        <div class="stat-card">
          <span class="stat-icon">üíä</span>
          <span class="stat-value" id="totalItems">0</span>
          <span class="stat-label">Total Items</span>
        </div>
        <div class="stat-card warning">
          <span class="stat-icon">‚ö†Ô∏è</span>
          <span class="stat-value" id="lowStockCount">0</span>
          <span class="stat-label">Low Stock</span>
        </div>
        <div class="stat-card danger">
          <span class="stat-icon">üìÖ</span>
          <span class="stat-value" id="expiringCount">0</span>
          <span class="stat-label">Expiring Soon</span>
        </div>
      </section>

      <!-- Medicine Cards - Dynamically Loaded -->
      <section class="medicine-list" id="medicineList">
        <!-- Cards will be injected by JavaScript -->
      </section>
    </main>

    <!-- Fixed Bottom Toolbar -->
    <footer class="fixed-toolbar">
      <a class="toolbar-btn primary" href="newMed.html">
        <span class="toolbar-icon">‚ûï</span>
        <span class="toolbar-label">Add</span>
      </a>
      <a class="toolbar-btn" href="editStock.html">
        <span class="toolbar-icon">‚úèÔ∏è</span>
        <span class="toolbar-label">Edit</span>
      </a>
      <a class="toolbar-btn" href="stock.html">
        <span class="toolbar-icon">üìã</span>
        <span class="toolbar-label">Report</span>
      </a>
      <a class="toolbar-btn" href="Pharmacy.html">
        <span class="toolbar-icon">üó∫Ô∏è</span>
        <span class="toolbar-label">Pharmacy</span>
      </a>
    </footer>

    <!-- Shared Utilities -->
    <script src="inventoryUtils.js"></script>

    <script>
      // Create medicine card HTML
      function createMedicineCard(med, alertType = null) {
        let cardClass = "medicine-card";
        let badge = "";
        let qtyClass = "";

        if (alertType === "low") {
          cardClass += " alert-low";
          badge = `<span class="alert-badge">Low Stock</span>`;
        } else if (alertType === "expiry") {
          cardClass += " alert-expiry";
          badge = `<span class="alert-badge expiry">Expiring</span>`;
        } else if (alertType === "expired") {
          cardClass += " alert-expiry";
          badge = `<span class="alert-badge expiry">Expired!</span>`;
        } else if (med.Qty > LOW_STOCK_THRESHOLD) {
          qtyClass = "good";
        }

        return `
          <article class="${cardClass}">
            <div class="med-info">
              <h3 class="med-name">${med.MedName}</h3>
              <p class="med-detail">Batch #${med.Batch} ‚Ä¢ Exp: ${med.ExpDate}</p>
            </div>
            <div class="med-qty ${qtyClass}">
              <span class="qty-number">${med.Qty}</span>
              <span class="qty-label">left</span>
            </div>
            ${badge}
          </article>
        `;
      }

      // Render the inventory
      async function renderInventory() {
        const inventory = await loadInventory();
        const medicineList = document.getElementById("medicineList");

        // Categorize medicines
        const alertMeds = [];
        const normalMeds = [];

        inventory.forEach((med) => {
          const expired = isExpired(med.ExpDate);
          const expiring = isExpiringSoon(med.ExpDate);
          const lowStock = isLowStock(med.Qty);

          if (expired) {
            alertMeds.push({ ...med, alertType: "expired" });
          } else if (expiring && lowStock) {
            // Both issues - prioritize expiry
            alertMeds.push({ ...med, alertType: "expiry" });
          } else if (lowStock) {
            alertMeds.push({ ...med, alertType: "low" });
          } else if (expiring) {
            alertMeds.push({ ...med, alertType: "expiry" });
          } else {
            normalMeds.push(med);
          }
        });

        // Update stats
        const lowStockCount = inventory.filter((m) => isLowStock(m.Qty)).length;
        const expiringCount = inventory.filter(
          (m) => isExpiringSoon(m.ExpDate) || isExpired(m.ExpDate),
        ).length;
        const totalAlerts = alertMeds.length;

        document.getElementById("totalItems").textContent = inventory.length;
        document.getElementById("lowStockCount").textContent = lowStockCount;
        document.getElementById("expiringCount").textContent = expiringCount;
        document.getElementById("alertCount").textContent =
          `${totalAlerts} alert${totalAlerts !== 1 ? "s" : ""}`;

        // Build HTML
        let html = "";

        if (alertMeds.length > 0) {
          html += `<h2 class="section-title">‚ö° Needs Attention</h2>`;
          alertMeds.forEach((med) => {
            html += createMedicineCard(med, med.alertType);
          });
        }

        if (normalMeds.length > 0) {
          html += `<h2 class="section-title">‚úì All Medicines</h2>`;
          normalMeds.forEach((med) => {
            html += createMedicineCard(med);
          });
        }

        if (inventory.length === 0) {
          html = `
            <div class="empty-state">
              <p>No medicines in inventory yet.</p>
              <p>Tap <strong>Add</strong> below to get started!</p>
            </div>
          `;
        }

        medicineList.innerHTML = html;
      }

      // Initialize on page load
      renderInventory();
    </script>
  </body>
</html>
