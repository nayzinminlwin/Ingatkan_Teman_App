<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title data-i18n-title="inventory.pageTitle">Medicine Inventory</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="page inventory-home">
      <header class="page-header">
        <a href="../main/homePage.html" class="back-btn" data-i18n="common.back"
          >‚Üê Back</a
        >
        <h1 data-i18n="inventory.pageTitle">Medicine Inventory</h1>
      </header>

      <!-- PakCik Firdaus Welcome Scene -->
      <section class="scene">
        <img
          src="../assets/PakCik_Firdaus.png"
          alt="PakCik Firdaus"
          class="avatar"
        />
        <div class="bubble">
          <p>
            <span data-i18n="inventory.welcomeMessage"
              >Selamat datang, Nenek! You have</span
            >
            <strong class="alert-count" id="alertCount">0 alerts</strong>
            <span data-i18n="inventory.today">today.</span>
          </p>
        </div>
      </section>

      <!-- Quick Stats Dashboard -->
      <section class="stats-row">
        <div class="stat-card">
          <span class="stat-icon">üíä</span>
          <span class="stat-value" id="totalItems">0</span>
          <span class="stat-label" data-i18n="inventory.totalItems"
            >Total Items</span
          >
        </div>
        <div class="stat-card warning">
          <span class="stat-icon">‚ö†Ô∏è</span>
          <span class="stat-value" id="lowStockCount">0</span>
          <span class="stat-label" data-i18n="inventory.lowStock"
            >Low Stock</span
          >
        </div>
        <div class="stat-card danger">
          <span class="stat-icon">üìÖ</span>
          <span class="stat-value" id="expiringCount">0</span>
          <span class="stat-label" data-i18n="inventory.expiringSoon"
            >Expiring Soon</span
          >
        </div>
      </section>

      <!-- Medicine Cards - Dynamically Loaded -->
      <section class="medicine-list" id="medicineList">
        <!-- Cards will be injected by JavaScript -->
      </section>
    </main>

    <!-- Fixed Bottom Toolbar -->
    <footer class="fixed-toolbar">
      <a class="toolbar-btn primary" href="newMed.html">
        <span class="toolbar-icon">‚ûï</span>
        <span class="toolbar-label" data-i18n="inventory.add">Add</span>
      </a>
      <a class="toolbar-btn" href="editStock.html">
        <span class="toolbar-icon">‚úèÔ∏è</span>
        <span class="toolbar-label" data-i18n="inventory.edit">Edit</span>
      </a>
      <a class="toolbar-btn" href="stock.html">
        <span class="toolbar-icon">üìã</span>
        <span class="toolbar-label" data-i18n="inventory.report">Report</span>
      </a>
      <a class="toolbar-btn" href="Pharmacy.html">
        <span class="toolbar-icon">üó∫Ô∏è</span>
        <span class="toolbar-label" data-i18n="inventory.pharmacy"
          >Pharmacy</span
        >
      </a>
    </footer>

    <!-- i18n Script -->
    <script src="../i18n/i18n.js"></script>

    <!-- Shared Utilities -->
    <script src="inventoryUtils.js"></script>

    <script>
      // Create medicine card HTML
      function createMedicineCard(med, alertType = null) {
        let cardClass = "medicine-card";
        let badge = "";
        let qtyClass = "";

        if (alertType === "low") {
          cardClass += " alert-low";
          badge = `<span class="alert-badge">${I18n.t("inventory.lowStockBadge")}</span>`;
        } else if (alertType === "expiry") {
          cardClass += " alert-expiry";
          badge = `<span class="alert-badge expiry">${I18n.t("inventory.expiringBadge")}</span>`;
        } else if (alertType === "expired") {
          cardClass += " alert-expiry";
          badge = `<span class="alert-badge expiry">${I18n.t("inventory.expiredBadge")}</span>`;
        } else if (med.Qty > LOW_STOCK_THRESHOLD) {
          qtyClass = "good";
        }

        return `
          <article class="${cardClass}">
            <div class="med-info">
              <h3 class="med-name">${med.MedName}</h3>
              <p class="med-detail">Batch #${med.Batch} ‚Ä¢ Exp: ${med.ExpDate}</p>
            </div>
            <div class="med-qty ${qtyClass}">
              <span class="qty-number">${med.Qty}</span>
              <span class="qty-label">${I18n.t("inventory.left")}</span>
            </div>
            ${badge}
          </article>
        `;
      }

      // Render the inventory
      async function renderInventory() {
        const inventory = await loadInventory();
        const medicineList = document.getElementById("medicineList");

        // Categorize medicines
        const alertMeds = [];
        const normalMeds = [];

        inventory.forEach((med) => {
          const expired = isExpired(med.ExpDate);
          const expiring = isExpiringSoon(med.ExpDate);
          const lowStock = isLowStock(med.Qty);

          if (expired) {
            alertMeds.push({ ...med, alertType: "expired" });
          } else if (expiring && lowStock) {
            // Both issues - prioritize expiry
            alertMeds.push({ ...med, alertType: "expiry" });
          } else if (lowStock) {
            alertMeds.push({ ...med, alertType: "low" });
          } else if (expiring) {
            alertMeds.push({ ...med, alertType: "expiry" });
          } else {
            normalMeds.push(med);
          }
        });

        // Update stats
        const lowStockCount = inventory.filter((m) => isLowStock(m.Qty)).length;
        const expiringCount = inventory.filter(
          (m) => isExpiringSoon(m.ExpDate) || isExpired(m.ExpDate),
        ).length;
        const totalAlerts = alertMeds.length;

        document.getElementById("totalItems").textContent = inventory.length;
        document.getElementById("lowStockCount").textContent = lowStockCount;
        document.getElementById("expiringCount").textContent = expiringCount;

        const alertWord =
          totalAlerts !== 1
            ? I18n.t("inventory.alerts")
            : I18n.t("inventory.alert");
        document.getElementById("alertCount").textContent =
          `${totalAlerts} ${alertWord}`;

        // Build HTML
        let html = "";

        if (alertMeds.length > 0) {
          html += `<h2 class="section-title">‚ö° ${I18n.t("inventory.needsAttention")}</h2>`;
          alertMeds.forEach((med) => {
            html += createMedicineCard(med, med.alertType);
          });
        }

        if (normalMeds.length > 0) {
          html += `<h2 class="section-title">‚úì ${I18n.t("inventory.allMedicines")}</h2>`;
          normalMeds.forEach((med) => {
            html += createMedicineCard(med);
          });
        }

        if (inventory.length === 0) {
          html = `
            <div class="empty-state">
              <p>${I18n.t("inventory.noMedicines")}</p>
              <p>${I18n.t("inventory.tapAddToStart")}</p>
            </div>
          `;
        }

        medicineList.innerHTML = html;
      }

      // Initialize on page load - wait for i18n to be ready
      I18n.init(function () {
        renderInventory();
      });
    </script>
  </body>
</html>
