<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!-- BM: Perundingan Kesihatan dengan Encik Amirul -->
    <title>Health Consulting - Encik Amirul</title>
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="chatUI.css" />
  </head>
  <body class="theme-consult">
    <!-- ========== HEADER ========== -->
    <header class="chat-header">
      <a href="../main/homePage.html" class="back-btn" aria-label="Back">‚Üê</a>
      <div class="header-content">
        <div class="header-avatars single">
          <img
            src="../assets/Encik_Amirul.png"
            alt="Encik Amirul"
            class="header-avatar primary"
          />
        </div>
        <div class="header-info">
          <!-- BM: Encik Amirul -->
          <h1 id="headerTitle">Encik Amirul</h1>
          <p class="status-online">
            <!-- BM: Perunding Kesihatan -->
            <span class="status-dot"></span>
            <span id="headerStatus">Health Consultant</span>
          </p>
        </div>
      </div>
      <button class="menu-btn" id="menuBtn" aria-label="Menu">‚ãÆ</button>
    </header>

    <!-- ========== MENU DROPDOWN ========== -->
    <div class="menu-dropdown" id="menuDropdown">
      <button class="menu-item" id="resetConversation">
        üîÑ Start New Consultation
      </button>
    </div>

    <!-- ========== TOPIC CHIPS ========== -->
    <div class="topic-chips" id="topicChips">
      <!-- Filled dynamically -->
    </div>

    <!-- ========== CHAT CONTAINER ========== -->
    <main class="chat-container" id="chatContainer">
      <!-- Messages will be inserted here dynamically -->
    </main>

    <!-- ========== QUICK RESPONSE BUTTONS ========== -->
    <div class="quick-responses" id="quickResponses">
      <!-- Dynamic quick response buttons appear here -->
    </div>

    <!-- ========== INPUT AREA ========== -->
    <footer class="input-area">
      <div class="input-wrapper">
        <button class="voice-btn" id="voiceBtn" aria-label="Voice Input">
          üé§
        </button>
        <!-- BM placeholder: Tanya soalan kesihatan... -->
        <input
          type="text"
          id="messageInput"
          placeholder="Ask a health question..."
          class="message-input"
        />
        <button class="send-btn" id="sendBtn" aria-label="Send Message">
          ‚û§
        </button>
      </div>
    </footer>

    <script>
      // ========== CONFIGURATION ==========
      const DATA_PATH = "consultChat.JSON";
      const LANG = "en"; // Change to "bm" for Bahasa Melayu

      // Data containers
      let PERSONA = {};
      let TOPICS = [];
      let GREETINGS = [];
      let RESPONSES = {};
      let DISCLAIMERS = {};
      let UI = {};

      // State
      let currentTopic = null;
      let conversationHistory = [];
      let hasShownDisclaimer = false;

      // ========== DOM ELEMENTS ==========
      const chatContainer = document.getElementById("chatContainer");
      const quickResponses = document.getElementById("quickResponses");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const voiceBtn = document.getElementById("voiceBtn");
      const topicChips = document.getElementById("topicChips");

      // ========== LANGUAGE HELPER ==========
      function getText(obj, key) {
        if (!obj) return key;
        if (LANG === "bm" && obj[key + "_BM"]) {
          return obj[key + "_BM"];
        }
        return obj[key] || obj[key.replace("_BM", "")];
      }

      function getTextDirect(obj, suffix = "") {
        if (!obj) return "";
        const bmKey = suffix ? suffix + "_BM" : "label_BM";
        const enKey = suffix || "label";
        if (LANG === "bm" && obj[bmKey]) {
          return obj[bmKey];
        }
        return obj[enKey] || obj[bmKey.replace("_BM", "")];
      }

      // ========== INITIALIZE ==========
      document.addEventListener("DOMContentLoaded", async () => {
        await loadChatData();
        applyUIText();
        renderTopicChips();
        startConversation();
      });

      async function loadChatData() {
        try {
          const response = await fetch(DATA_PATH);
          const data = await response.json();

          PERSONA = data.persona;
          TOPICS = data.topics;
          GREETINGS = data.greetings;
          RESPONSES = data.responses;
          DISCLAIMERS = data.disclaimers;
          UI = data.ui;
        } catch (error) {
          console.error("Failed to load chat data:", error);
        }
      }

      function applyUIText() {
        document.getElementById("headerTitle").textContent = getText(
          UI.header,
          "title",
        );
        document.getElementById("headerStatus").textContent = getText(
          UI.header,
          "status",
        );
        document.getElementById("messageInput").placeholder = getText(
          UI.input,
          "placeholder",
        );
      }

      function renderTopicChips() {
        topicChips.innerHTML = TOPICS.map(
          (topic) => `
          <button class="topic-chip" data-topic="${topic.id}">
            ${getTextDirect(topic)}
          </button>
        `,
        ).join("");

        // Add click handlers
        topicChips.querySelectorAll(".topic-chip").forEach((chip) => {
          chip.addEventListener("click", () => {
            const topicId = chip.dataset.topic;
            selectTopic(topicId);

            // Visual feedback
            topicChips
              .querySelectorAll(".topic-chip")
              .forEach((c) => c.classList.remove("active"));
            chip.classList.add("active");
          });
        });
      }

      function selectTopic(topicId) {
        const topic = TOPICS.find((t) => t.id === topicId);
        if (!topic) return;

        currentTopic = topic;

        // Get a random starter from the topic
        const starters = LANG === "bm" ? topic.starters_BM : topic.starters;
        const starter = starters[Math.floor(Math.random() * starters.length)];

        // Add typing then message
        addTypingIndicator();
        setTimeout(() => {
          removeTypingIndicator();
          addMessage(PERSONA.name, starter, PERSONA.avatar);

          // Show disclaimer for medication topic
          if (topicId === "medication" && !hasShownDisclaimer) {
            setTimeout(() => {
              addSystemMessage(getText(DISCLAIMERS, "medication"));
              hasShownDisclaimer = true;
            }, 500);
          }
        }, 800);
      }

      // ========== CONVERSATION ==========
      function startConversation() {
        // Determine time of day
        const hour = new Date().getHours();
        let timeOfDay = "morning";
        if (hour >= 12 && hour < 17) timeOfDay = "afternoon";
        else if (hour >= 17) timeOfDay = "evening";

        const greeting = GREETINGS.find((g) => g.time === timeOfDay);
        const message = LANG === "bm" ? greeting.message_BM : greeting.message;

        // Show greeting after delay
        setTimeout(() => {
          addTypingIndicator();
          setTimeout(() => {
            removeTypingIndicator();
            addMessage(PERSONA.name, message, PERSONA.avatar);

            // Show general disclaimer
            setTimeout(() => {
              addSystemMessage(getText(DISCLAIMERS, "general"));
            }, 800);
          }, 1000);
        }, 500);
      }

      // ========== MESSAGE RENDERING ==========
      function addMessage(sender, text, avatar = null, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${isUser ? "user-message" : "ai-message"}`;

        if (!isUser) {
          messageDiv.innerHTML = `
            <img src="${avatar}" alt="${sender}" class="message-avatar" />
            <div class="message-content">
              <span class="message-sender">${sender}</span>
              <div class="message-bubble">${text}</div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="message-bubble">${text}</div>
            </div>
          `;
        }

        chatContainer.appendChild(messageDiv);
        conversationHistory.push({ sender, text, isUser });
        scrollToBottom();
      }

      function addSystemMessage(text) {
        const systemDiv = document.createElement("div");
        systemDiv.className = "system-message";
        systemDiv.innerHTML = `<div class="system-bubble">${text}</div>`;
        chatContainer.appendChild(systemDiv);
        scrollToBottom();
      }

      function addTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.className = "message ai-message typing-indicator";
        typingDiv.id = "typingIndicator";
        typingDiv.innerHTML = `
          <img src="${PERSONA.avatar}" alt="${PERSONA.name}" class="message-avatar" />
          <div class="message-content">
            <div class="message-bubble typing">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </div>
          </div>
        `;
        chatContainer.appendChild(typingDiv);
        scrollToBottom();
      }

      function removeTypingIndicator() {
        const indicator = document.getElementById("typingIndicator");
        if (indicator) indicator.remove();
      }

      function scrollToBottom() {
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 50);
      }

      // ========== AI RESPONSE ==========
      function getAIResponse(userMessage) {
        const msg = userMessage.toLowerCase();

        // Check for concerning keywords - suggest doctor
        if (
          msg.includes("pain") ||
          msg.includes("hurt") ||
          msg.includes("bleed") ||
          msg.includes("sakit") ||
          msg.includes("berdarah") ||
          msg.includes("emergency")
        ) {
          const caution =
            LANG === "bm" ? RESPONSES.caution_BM : RESPONSES.caution;
          return caution[Math.floor(Math.random() * caution.length)];
        }

        // Positive/good progress
        if (
          msg.includes("better") ||
          msg.includes("improve") ||
          msg.includes("good") ||
          msg.includes("baik") ||
          msg.includes("bagus") ||
          msg.includes("sembuh")
        ) {
          const encourage =
            LANG === "bm"
              ? RESPONSES.encouragement_BM
              : RESPONSES.encouragement;
          return encourage[Math.floor(Math.random() * encourage.length)];
        }

        // Worried/anxious
        if (
          msg.includes("worried") ||
          msg.includes("scared") ||
          msg.includes("anxious") ||
          msg.includes("risau") ||
          msg.includes("takut") ||
          msg.includes("bimbang")
        ) {
          const reassure =
            LANG === "bm" ? RESPONSES.reassurance_BM : RESPONSES.reassurance;
          return reassure[Math.floor(Math.random() * reassure.length)];
        }

        // Default: informative response + follow-up
        const info =
          LANG === "bm" ? RESPONSES.informative_BM : RESPONSES.informative;
        const followUp =
          LANG === "bm" ? RESPONSES.followUp_BM : RESPONSES.followUp;
        return (
          info[Math.floor(Math.random() * info.length)] +
          " " +
          followUp[Math.floor(Math.random() * followUp.length)]
        );
      }

      // ========== TEXT INPUT HANDLING ==========
      sendBtn.addEventListener("click", sendTextMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendTextMessage();
      });

      function sendTextMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        // Show user message
        addMessage("You", text, null, true);
        messageInput.value = "";

        // Generate AI response
        setTimeout(() => {
          addTypingIndicator();
          setTimeout(
            () => {
              removeTypingIndicator();
              const response = getAIResponse(text);
              addMessage(PERSONA.name, response, PERSONA.avatar);
            },
            1200 + Math.random() * 800,
          ); // Slightly longer for "thinking"
        }, 300);
      }

      // ========== VOICE INPUT (Placeholder) ==========
      voiceBtn.addEventListener("click", () => {
        voiceBtn.classList.toggle("recording");

        if (voiceBtn.classList.contains("recording")) {
          voiceBtn.textContent = "üî¥";

          setTimeout(() => {
            voiceBtn.classList.remove("recording");
            voiceBtn.textContent = "üé§";
            messageInput.value = getText(UI, "voicePlaceholder");
            messageInput.focus();
          }, 2000);
        }
      });

      // ========== MENU DROPDOWN ==========
      const menuBtn = document.getElementById("menuBtn");
      const menuDropdown = document.getElementById("menuDropdown");
      const resetBtn = document.getElementById("resetConversation");

      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle("visible");
      });

      document.addEventListener("click", () => {
        menuDropdown.classList.remove("visible");
      });

      resetBtn.addEventListener("click", () => {
        // Clear chat
        chatContainer.innerHTML = "";
        conversationHistory = [];
        currentTopic = null;
        hasShownDisclaimer = false;

        // Reset topic chips
        topicChips
          .querySelectorAll(".topic-chip")
          .forEach((c) => c.classList.remove("active"));

        // Start fresh
        startConversation();
        menuDropdown.classList.remove("visible");
      });
    </script>

    <style>
      /* System message styling for disclaimers */
      .system-message {
        display: flex;
        justify-content: center;
        margin: 12px 0;
        animation: messageSlide 0.3s ease-out;
      }

      .system-bubble {
        background: rgba(52, 73, 94, 0.1);
        border: 1px solid rgba(52, 73, 94, 0.2);
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 14px;
        color: var(--text-secondary);
        max-width: 90%;
        text-align: center;
        line-height: 1.4;
      }
    </style>
  </body>
</html>
